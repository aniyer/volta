services:
  # Backend: PocketBase (Database, Auth, and API)
  volta-backend:
    image: ghcr.io/muchobien/pocketbase:latest
    container_name: volta_pb
    restart: unless-stopped
    ports:
      - "8090:8090"
    volumes:
      - /mnt/applications/volta/pb_data:/usr/local/bin/pb_data
      - ./pb_migrations:/usr/local/bin/pb_migrations
      - ./pb_hooks:/usr/local/bin/pb_hooks
    command: serve --http=0.0.0.0:8090
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8090/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Flutter Build Container
  flutter-build:
    build:
      context: .
      dockerfile: Dockerfile.flutter
      target: builder
    network_mode: bridge # Use bridge to ensure internet access for pub get
    container_name: volta_build
    volumes:
      - ./volta_app:/app
      - flutter_cache:/root/.pub-cache
    working_dir: /app
    profiles:
      - build
    command: flutter build web --release

  # Frontend: Nginx serving Flutter Web
  volta-frontend:
    image: nginx:alpine
    container_name: volta_ui
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./volta_app/build/web:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      volta-backend:
        condition: service_healthy

volumes:
  flutter_cache:

networks:
  default:
    name: internal_network
    external: true
